name: AWS Report Notification

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Generate AWS report
      run: |
        chmod +x scripts/collect_aws_info.sh
        ./scripts/collect_aws_info.sh

    - name: Find latest report
      id: report
      run: |
        FILE=$(ls reports/aws_report_*.md | tail -n 1)
        echo "file=$FILE" >> $GITHUB_OUTPUT

    - name: Send email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "AWS Report generado autom√°ticamente"
        body: |
          El reporte AWS fue generado correctamente.
          Archivo adjunto.
        to: saavlean@gmail.com
        from: "AWS Automation <saavlean@gmail.com>"
        attachments: ${{ steps.report.outputs.file }}

